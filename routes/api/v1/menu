const express = require('express')
const router = express.Router()
const { getCollection, ObjectId } = require('../../../dbconnect')

let collection = null

const getMenu = async () => {
    if (!collection) collection = await getCollection('FoodTruckAPI', 'Menu')
    return collection
}


// GET /api/v1/menu - Retrieve all menu items
router.get('/', async (req, res) => {
    const menu = await (await getMenu()).find({}).toArray()
    res.send(menu)
})


// GET /api/v1/menu/:id - Retrieve a specific menu item by Mongo _id
router.get('/:id', async (req, res) => {
    try {
        const { id } = req.params

        // find by MongoDB _id
        const item = await (await getMenu()).findOne({ _id: new ObjectId(id) })

        if (item) {
            res.send(item)
        } else {
            res.status(404).send({ error: { message: 'Menu item not found' } })
        }
    } catch (err) {
        // usually means the id isn't a valid ObjectId
        res.status(400).send({ error: { message: 'Invalid menu id' } })
    }
})


// POST /api/v1/menu - Create a new menu item
router.post('/', async (req, res) => {
    const { name, description, price, imageUrl } = req.body

    const collection = await getMenu()

    const { acknowledged, insertedId } = await collection.insertOne({
        name,
        description,
        price: Number(price),
        imageUrl
    })

    res.send({ acknowledged, insertedId })
})

module.exports = router
